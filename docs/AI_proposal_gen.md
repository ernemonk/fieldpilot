# AI Proposal Generator — Feature Spec

Purpose
- Let owners/admins generate professional engineering proposals from minimal inputs (project name, client, description, specs, and photos) using AI-generated Markdown that can be edited and saved as a Proposal document.

Who can use
- Roles: `owner`, `admin` (enforced by the component RoleGuard)

Inputs collected in the UI
- Optional link to an existing Job
- Project Name
- Client Name
- Voice description (UI stub / TODO for speech capture)
- Text description
- Technical specs (freeform)
- Site photos (client-side previews; stored as filenames until Storage is wired)

Basic UI flow
- User fills the form and clicks **Generate Proposal with AI**.
- The UI simulates AI processing (placeholder) and displays a Markdown proposal string.
- The user can toggle Edit mode to modify the generated Markdown before saving.
- Saving calls `createProposal` to persist a `Proposal` document in Firestore.

Where to find the implementation
- UI and logic: [src/app/(app)/ai/proposal/page.tsx](src/app/(app)/ai/proposal/page.tsx#L1-L120)
- Firestore helpers: [src/lib/firestore.ts](src/lib/firestore.ts#L200-L300)
- Types: [src/lib/types.ts](src/lib/types.ts#L80-L140)

Firestore data model (fields used by this feature)
- Collection path: `tenants/{tenantId}/proposals`
- Key `Proposal` fields (from types):
	- `jobId: string` (linked job, may be empty)
	- `specsJson: Record<string, unknown>` (payload containing `projectName`, `clientName`, `description`, `specs`)
	- `images: string[]` (filenames until Storage upload wired)
	- `aiGeneratedText?: string` (Markdown proposal text saved on creation)
	- `priceEstimate: number`
	- `version: number`
	- `status: 'draft'|'sent'|'viewed'|'approved'|'rejected'`

Generated proposal template (current placeholder produced by the UI)
```md
# Engineering Proposal
## ${projectName || 'Electrical System Upgrade'}

**Prepared for:** ${clientName || 'Client'}
**Prepared by:** FieldPilot Engineering
**Date:** ${new Date().toLocaleDateString()}
**Version:** 1.0

---

## 1. Executive Summary

This proposal outlines the scope, timeline, and cost for ${projectName || 'the requested project'}. ${description || 'The project involves comprehensive electrical work requiring professional assessment and execution.'}

## 2. Scope of Work

Based on the provided specifications${photos.length > 0 ? ' and site photos' : ''}, the following work items are included:

### 2.1 Phase 1 — Assessment & Planning
- Complete site survey and hazard assessment
- Engineering drawings and load calculations
- Permit acquisition and code compliance review
- Material procurement and scheduling

### 2.2 Phase 2 — Execution
- Demolition of existing infrastructure (if applicable)
- Installation of new electrical systems per NEC standards
- Conduit routing, wire pulling, and termination
- Panel installation and circuit configuration

## 3. Technical Specifications

${specs || `- Main panel: 200A, 42-circuit load center
- Branch circuits: 20A dedicated circuits for heavy equipment
- Conduit: EMT for exposed runs, NM-B for concealed
- All work per NEC 2023 and local amendments`}

## 4. Timeline

| Phase | Duration | Start |
|-------|----------|-------|
| Assessment & Planning | 1 week | Upon approval |
| Material Procurement | 1–2 weeks | Week 2 |
| Execution | 2–3 weeks | Week 3 |
| Testing & Commissioning | 3 days | Week 6 |
| **Total** | **~6 weeks** | — |

## 5. Investment

| Item | Cost |
|------|------|
| Labor (estimated 160 hours) | $12,800 |
| Materials & Equipment | $8,500 |
| Permits & Inspections | $1,200 |
| Project Management | $2,000 |
| **Total** | **$24,500** |

*Payment terms: 30% upon approval, 40% at Phase 2 completion, 30% upon final commissioning.*

---
*Proposal generated by FieldPilot AI — ${new Date().toLocaleString()}*
```

Integration notes & next steps to connect real AI
- Current behavior: the client simulates AI output in `handleGenerate` (3s timeout). The app supports editing before saving; `createProposal` persists the proposal document.
- To integrate a real AI pipeline:
	1. Add a server-side API endpoint that calls the chosen LLM and returns Markdown.
	2. Optionally run server-side image analysis or include image URLs (upload to Storage first).
	3. Replace the placeholder in `handleGenerate` with the real API call and validate / sanitize returned Markdown.
	4. Consider generating a PDF server-side or using a client-side PDF generator for export.

Developer pointers
- Edit generation flow: [src/app/(app)/ai/proposal/page.tsx](src/app/(app)/ai/proposal/page.tsx#L120-L220)
- Persisted fields: `Proposal` in [src/lib/types.ts](src/lib/types.ts#L100-L140)
- Firestore create helper: [src/lib/firestore.ts](src/lib/firestore.ts#L200-L280)

**Canonical LLM Prompt (Proposal Generator)**

System:
- You are an experienced technical proposal writer for field engineering projects. Produce professional, client-facing proposals in clear Markdown with a neutral, persuasive tone and explicit assumptions. Avoid hallucinations; if cost/timelines are estimated, mark them as `[ESTIMATE]` and provide a conservative value.

User (input JSON):
- Provide exactly these keys (missing keys may be null/empty):
  - `projectName` (string)
  - `clientName` (string)
  - `description` (free text: goals/constraints/site notes)
  - `specs` (free text: technical specs or bullet points)
  - `photos` (array of strings — captions or URLs)
  - `budgetRange` (string or object; optional, e.g., "$20k-$30k")
  - `preferredTimeline` (string; e.g., "start asap", "Q2 2026")
  - `siteConstraints` (string; optional)
  - `additionalNotes` (string; optional)

Task:
1. Produce a Markdown proposal with these sections:
	- Title: `# Engineering Proposal` and subheading with `## <Project Name>`
	- Prepared for / Prepared by / Date / Version lines
	- `## Executive Summary` — 1–3 paragraphs summarizing goals and value.
	- `## Scope of Work` — clear, numbered deliverables.
	- `## Phases & Tasks` — break into Phase 1/2/3 with bullets and estimated durations (e.g., "1 week", "2–3 weeks").
	- `## Technical Specifications` — translate `specs` into clear bullet points; include photo-based notes if `photos` present.
	- `## Timeline` — small table (Phase | Duration | Start) or bullets.
	- `## Investment` — cost breakdown table (Labor, Materials, Permits, Project Management, Total). If exact numbers missing, provide conservative `[ESTIMATE]` values and label them.
	- `## Payment Terms` — simple terms (e.g., 30/40/30) and milestones.
	- `## Assumptions & Exclusions` — explicit bullets of what is *not* included.
	- `## Acceptance` — signature block and next steps.
	- Footer: one-line timestamp and `*Confidence: 0.x*`.

2. Also output a compact JSON object after the Markdown (separator `---json---`) with:
	- `totalEstimate` (number)
	- `currency` (string, default "USD")
	- `breakdown` (object: `{ labor:number, materials:number, permits:number, other:number }`)
	- `durationWeeks` (number)
	- `requiredPermits` (array of strings)
	- `tags` (array of short strings)

Formatting & constraints:
- Output only the Markdown then `---json---` then the JSON. No extra commentary.
- Keep proposal length under ~1200 words.
- Where cost/timeline is estimated, mark values with `[ESTIMATE]` and include a short justification in `Assumptions & Exclusions`.
- If `budgetRange` exists, provide a recommended proposal total within that range and explain tradeoffs.

Example (input → expected parts):
- Input: `{ "projectName":"Panel Upgrade","clientName":"Acme Corp","description":"Replace 200A panel","specs":"200A main, new 42-space panel","photos":["panel_old.jpg"],"budgetRange":"$20k-$30k","preferredTimeline":"2–6 weeks" }`
- Output: Markdown with Executive Summary, Scope, Timeline table, Investment with conservative numbers labeled `[ESTIMATE]`, and JSON with `totalEstimate` equal to the chosen total.


